{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4"><i class="fas fa-receipt"></i>  Parking History</h2>

  {% if reservations %}
  {% set ns = namespace(total_cost=0) %}
    <div class="table-responsive shadow-sm">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th scope="col">Spot ID</th>
            <th scope="col">Parking Lot</th>
            <th scope="col">Start Time</th>
            <th scope="col">End Time</th>
            <th scope="col">Cost ($)</th>
          </tr>
        </thead>
        <tbody>
          {% for res in reservations %}
          <tr>
            <td>{{ res.spot_id }}</td>
            <td>{{ res.spot.lot.prime_location_name }}</td>
            <td>{{ res.parking_time.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              {% if res.leaving_time %}
                {{ res.leaving_time.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                <span class="badge bg-warning text-dark">In Progress</span>
              {% endif %}
            </td>
            <td>
              {% if res.leaving_time %}
                {% set total_seconds = (res.leaving_time - res.parking_time).total_seconds() %}
                {% set hours = (total_seconds // 3600) %}
                {% if hours < 1 %}
                  {% set cost = res.cost_per_hour %}
                {% else %}
                  {% set cost = hours * res.cost_per_hour %}
                {% endif %}
                ${{ cost }}
                {% set ns.total_cost = ns.total_cost + cost %}
              {% else %}
                <span class="text-warning">In Progress</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="text-end fw-bold">Total Cost</td>
            <td class="fw-bold text-success">${{ ns.total_cost }}</td>
          </tr>
      </tfoot>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">You have no parking history yet.</div>
  {% endif %}

  <div class="text-end mt-4">
    <a href="{{ url_for('user.dashboard') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
  </div>
</div>
{% endblock %}
